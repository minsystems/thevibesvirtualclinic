{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %} Home {% endblock title %}

{% block header-content %}
    Register
{% endblock header-content %}

{% block header-description %}
    The Vibes Virtual Clinic is a membership/one-off based primary care practice on a mission to make getting quality
    care more affordable, accessible, and enjoyable for all through a blend of human-centered design, technology,
    and an exceptional team.
{% endblock header-description %}

{% block content %}

    <section class="section bg-light">
      <div class="container">
        <div class="row">
            <div class="col-sm-6">

                <form class="registerForm" action="{% url 'api-auth:register-api' %}" method="POST"> {% csrf_token %}
                  <div class="form-group">
                      <label for="appointment_firstname" class="text-black">First Name</label>
                      <input type="text" class="form-control" id="first_name" placeholder="First name" required="required">
                  </div>

                  <div class="form-group">
                      <label for="appointment_lastname" class="text-black">Last Name</label>
                      <input type="text" class="form-control" id="last_name" placeholder="Last name" required="required">
                  </div>

                  <div class="form-group">
                      <label for="appointment_handle" class="text-black">Handle</label>
                      <input type="text" class="form-control" id="username" placeholder="Username" required="required">
                  </div>

                  <div class="form-group">
                      <label for="appointment_phone" class="text-black">Phone</label>
                      <input type="text" class="form-control" id="phone" placeholder="Phone: +23480XXXXXXXX" required="required">
                  </div>

                  <div class="form-group">
                      <label for="appointment_email" class="text-black">Email</label>
                      <input type="email" class="form-control" id="email" placeholder="Email" required="required">
                  </div>

                  <div class="form-group">
                      <label for="appointment_password" class="text-black">Password</label>
                      <input type="password" name="password" class="form-control" id="password" placeholder="Password" required="required">
                  </div>

                  <div class="form-group">
                      <label for="appointment_password_confirm" class="text-black">Confirm Password</label>
                      <input type="password" name="confirm_password" class="form-control" id="confirm_password" placeholder="Retype password" required="required">
                  </div>

                  <div class="row">
                      <div class="col-8">
                        <div class="icheck-primary">
                          <input type="checkbox" id="agreeTerms" name="terms" value="agree" required>
                          <label for="agreeTerms">I agree to the <a href="{% url 't_and_c' %}">terms</a></label>
                        </div>
                      </div>
                      <!-- /.col -->
                      <div class="col-4">
                        <button type="submit" id="registerButton" class="btn btn-primary btn-block">Register</button>
                      </div>
                      <!-- /.col -->
                  </div>
                </form>
                <a href="{% url 'account-url:login' %}" class="text-center">I already have a membership</a>

            </div>
            <div class="col-sm-6">
                <h1 class="lead">
                    The VibesVirtual Clinic is your one touch healthcare provider on a mission to make getting quality care more affordable,
                    accessible and enjoyable for all through an array of our growing team of health professionals
                    and a blend of human-centred design and technology in telemedicine.
                </h1>
            </div>
        </div>
      </div>
    </section>

{% endblock content %}

{% block js_scripts %}

    <script>
    $( function() {
        'use strict';
        // $("#age").datepicker();

        $(document).ready(function () {
            // Initialize form data
            var registerForm = $(".registerForm");
            var registerFormMethod = registerForm.attr("method");
            var registerFormEnpoint = registerForm.attr("action");

            function displaySubmitting(submitBtn, defaultText, doSubmit) {
                if (doSubmit) {
                    submitBtn.addClass("disabled");
                    submitBtn.html("<i class='fa fa-spin fa-spinner'></i> Sending Data..");
                } else {
                    submitBtn.removeClass("disabled");
                    submitBtn.add(defaultText);
                }
            }

            function handleButton(submitBtn, doSubmit) {
                if (doSubmit){
                    submitBtn.addClass("disabled");
                } else {
                    submitBtn.removeClass("disabled");
                }
            }

            var registerFormSubmitBtn = registerForm.find("[type='submit']");
            var registerFormSubmitBtnText = registerFormSubmitBtn.text();

            // disable button on page-load
            handleButton(registerFormSubmitBtn, true);

            var checker = document.getElementById('agreeTerms');
            checker.onchange = function(){
                if (this.checked){
                    // perform our custom action here
                    handleButton(registerFormSubmitBtn, false); // activates button onCheck!
                    registerForm.submit(function (event) {
                        event.preventDefault();

                        // using jQuery
                        function getCookie(name) {
                            var cookieValue = null;
                            if (document.cookie && document.cookie !== '') {
                                var cookies = document.cookie.split(';');
                                for (var i = 0; i < cookies.length; i++) {
                                    var cookie = jQuery.trim(cookies[i]);
                                    // Does this cookie string begin with the name we want?
                                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                    }
                                }
                            }
                            return cookieValue;
                        }
                        var csrftoken = getCookie('csrftoken');

                        function csrfSafeMethod(method) {
                            // these HTTP methods do not require CSRF protection
                            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                        }
                        $.ajaxSetup({
                            beforeSend: function(xhr, settings) {
                                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                                }
                            }
                        });

                        // var registerFormData = registerForm.serialize(); // do not serialize the data, drf would do that
                        var registerFormData = {
                            "username": $('#username').val(),
                            "first_name": $('#first_name').val(),
                            "last_name": $('#last_name').val(),
                            "phone": $('#phone').val(),
                            "email": $('#email').val(),
                            "password": $('#password').val(),
                            "confirm_password": $('#confirm_password').val(),
                        };
                        var thisForm = $(this);

                        displaySubmitting(registerFormSubmitBtn, "", true);

                        console.log(registerFormData);

                        $.ajax({
                        method: registerFormMethod,
                        url: registerFormEnpoint,
                        data: registerFormData,
                        contentType: 'application/x-www-form-urlencoded',
                        dataType: 'json',

                        success: function (data) {
                            registerForm[0].reset();
                            console.log(data);
                            $.alert({
                                icon: 'fa fa-check',
                                title: 'Successful registration for' + data.email,
                                content: data.message,
                                theme: 'white',
                                backgroundDismiss: true,
                                animationSpeed: 2000,
                            });
                            setTimeout(function(){
                                displaySubmitting(registerFormSubmitBtn, registerFormSubmitBtnText, false)
                            }, 5000)
                        }, error: function (error) {
                            console.log(error);
                            $.alert({
                                icon: 'fa fa-warning',
                                title: 'Oops!',
                                content: error.responseJSON.email[0],
                                theme: 'white',
                                backgroundDismiss: true,
                                animationSpeed: 2000,
                            });
                        }
                    })

                    })
                } else {
                    handleButton(registerFormSubmitBtn, true);
                }
            }
        })
    } (jQuery));
  </script>

{% endblock js_scripts %}